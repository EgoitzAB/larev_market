{% extends "page/base.html" %}
{% load static %}

{% block body_class %}
    bg-dark text-white
{% endblock body_class %}
    
{% block navbar %}
{% include 'page/navbar.html' %}
{% endblock navbar %}
{% block content %}
<div class="checkout-container container">
    <h1 class="mb-4">Checkout</h1>
    <form method="post" id="checkout-form">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-6 mb-4" id="direccion-col">
                <h2 class="text-success mb-3">Datos de Envío</h2>
                <div id="envio-section">
                    <div class="mb-3">
                        <label class="form-check">
                            <input type="radio" name="tipo_direccion" value="existente" checked class="form-check-input" id="direccion-existente-radio">
                            <span class="form-check-label">Usar dirección guardada</span>
                        </label>
                        <label class="form-check">
                            <input type="radio" name="tipo_direccion" value="nueva" class="form-check-input" id="nueva-direccion-radio">
                            <span class="form-check-label">Ingresar nueva dirección</span>
                        </label>
                    </div>
                    <div id="lista-direcciones">
                        {% if direcciones.exists %}
                            <ul class="list-unstyled">
                                {% for direccion in direcciones %}
                                    <li class="mb-3 p-3 bg-light rounded text-dark" id="direccion-{{ direccion.id }}">
                                        <label class="d-flex align-items-center">
                                            <input type="radio" name="direccion_id" value="{{ direccion.id }}" class="me-3">
                                            <div>
                                                <strong>{{ direccion.nombre_completo }}</strong><br>
                                                {{ direccion.direccion }}, {{ direccion.ciudad }} - {{ direccion.codigo_postal }}, {{ direccion.pais }}
                                            </div>
                                        </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No tienes direcciones guardadas.</p>
                        {% endif %}
                    </div>
                    <div id="nueva-direccion-form" style="display: none;">
                        <h5 class="text-light">Nueva dirección:</h5>
                        <div class="mb-3">
                            {{ form.as_p }}
                        </div>
                    </div>
                </div>
                <div id="recogida-section" style="display: none;">
                    <h5 class="text-light">Nombre del Cliente:</h5>
                    <input type="text" name="nombre_cliente_recogida" class="form-control" placeholder="Tu nombre" required>
                    <div class="alert alert-warning mt-3" role="alert">
                        <strong>Importante:</strong> El pedido se reservará durante <strong>48 horas</strong> desde la confirmación. Después de ese plazo, los productos podrían volver a estar disponibles para otros clientes.
                    </div>
                    <small class="text-muted">La dirección será la de nuestra tienda.</small>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <h2 class="text-success mb-3">Método de Entrega</h2>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="metodo_entrega" id="envio" value="envio" checked>
                    <label class="form-check-label" for="envio">Envío a domicilio</label>
                </div>
                <div class="form-check mb-4">
                    <input class="form-check-input" type="radio" name="metodo_entrega" id="recogida" value="recogida">
                    <label class="form-check-label" for="recogida">Recogida en tienda</label>
                </div>
                <h2 class="text-success mb-3">Método de Pago</h2>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="metodo_pago" id="tarjeta" value="tarjeta" checked>
                    <label class="form-check-label" for="tarjeta">Tarjeta</label>
                </div>
                <div class="form-check mb-4" id="efectivo-option" style="display: none;">
                    <input class="form-check-input" type="radio" name="metodo_pago" id="efectivo" value="efectivo">
                    <label class="form-check-label" for="efectivo">Efectivo (solo recogida en tienda)</label>
                </div>
                <button type="submit" class="btn btn-success mt-3">Finalizar Pedido</button>
            </div>
        </div>
    </form>
    <hr class="my-4">
    <h2 class="text-success mb-3">Resumen del Carrito</h2>
    <div class="table-responsive">
        <table class="table table-bordered text-white">
            <thead class="table-success text-dark">
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in carrito %}
                <tr>
                    <td>{{ item.producto.nombre }}</td>
                    <td>{{ item.cantidad }}</td>
                    <td>{{ item.precio }} €</td>
                    <td>{{ item.precio_total }} €</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if cupon %}
    <div class="alert alert-info mt-3">
        Cupón aplicado: <strong>{{ cupon.code }}</strong> - Descuento: {{ descuento }} €
    </div>
    {% endif %}
    <div class="total-section mt-4">
        <p class="subtotal">Subtotal: <span>{{ carrito.carrito_total }} €</span></p>
        {% if cupon %}
        <p class="discount">Descuento: <span>- {{ descuento }} €</span></p>
        {% endif %}
        <h3 class="total mt-3">Total: <span class="text-success">{{ carrito.get_total_price_after_discount|floatformat:2 }} €</span></h3>
    </div>
</div>
{% endblock content %}
{% block javascript %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Métodos de entrega
        const metodoEnvio = document.getElementById('envio');
        const metodoRecogida = document.getElementById('recogida');
        const envioSection = document.getElementById('envio-section');
        const recogidaSection = document.getElementById('recogida-section');
        const efectivoOption = document.getElementById('efectivo-option');
        const efectivoRadio = document.getElementById('efectivo');
        const tarjetaRadio = document.getElementById('tarjeta');

        // Dirección
        const direccionExistenteRadio = document.getElementById("direccion-existente-radio");
        const nuevaDireccionRadio = document.getElementById("nueva-direccion-radio");
        const listaDirecciones = document.getElementById("lista-direcciones");
        const nuevaDireccionForm = document.getElementById("nueva-direccion-form");

        function actualizarEntregaYFormaPago() {
            if (metodoRecogida.checked) {
                envioSection.style.display = "none";
                recogidaSection.style.display = "block";
                efectivoOption.style.display = "block";
            } else {
                envioSection.style.display = "block";
                recogidaSection.style.display = "none";
                efectivoOption.style.display = "none";
                tarjetaRadio.checked = true;
            }
        }

        function actualizarDireccion() {
            if (direccionExistenteRadio.checked) {
                listaDirecciones.style.display = "block";
                nuevaDireccionForm.style.display = "none";
            } else if (nuevaDireccionRadio.checked) {
                listaDirecciones.style.display = "none";
                nuevaDireccionForm.style.display = "block";
            }
        }

        // Listeners
        metodoEnvio.addEventListener("change", actualizarEntregaYFormaPago);
        metodoRecogida.addEventListener("change", actualizarEntregaYFormaPago);

        direccionExistenteRadio.addEventListener("change", actualizarDireccion);
        nuevaDireccionRadio.addEventListener("change", actualizarDireccion);

        // Ejecutar al cargar
        actualizarEntregaYFormaPago();
        actualizarDireccion();
    });
</script>
{% endblock javascript %}

